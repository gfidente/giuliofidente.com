<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet/less" type="text/css" href="../../theme/css/style.less">
  <script src="../../theme/js/less-1.3.3.min.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="../../theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <title>Giulio Fidente (aka Giulivo Navigante) - My attempts at MapReduce with MongoDB</title>
  <meta charset="utf-8" />
    <link href="http://www.giuliofidente.im/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Giulio Fidente (aka Giulivo Navigante) Full Atom Feed" />
        </head>

<body>
  <aside>
    <div id="user_meta">
      <a href="../.."><img src="../../theme/images/gravatar_to192.png" alt="logo"></a>
      <h1><a href="../..">Giulio Fidente</a></h1>
      <h2>Only those so crazy to believe they can change the world, will change it.</h2>
      <ul>
                                                <li><a href="http://www.linkedin.com/in/gfidente" target="_blank">linkedin</a></li>
                <li><a href="https://github.com/giulivo" target="_blank">github</a></li>
                <li><a href="https://code.google.com/p/mlapd/" target="_blank">mlapd</a></li>
                        <li><a href="http://www.reddit.com/user/giulivo" target="_blank">reddit</a></li>
                <li><a href="http://news.ycombinator.com/user?id=giulivo" target="_blank">hn</a></li>
                <li><a href="https://coderwall.com/gfidente" target="_blank">coderwall</a></li>
                <li><a href="http://identi.ca/giulivo" target="_blank">identi.ca</a></li>
                <li><a href="https://github.com/giulivo/pelican-svbhack" target="_blank">blog template</a></li>
              </ul>
    </div>
  </aside>

  <main>
    <header>
  <h3>Posted on Thu 14 June 2012</h3>
</header>
<article>
  <div id="article_title">
    <a href="../../2012/06/my-attempts-at-mapreduce-with-mongodb.html" rel="bookmark" title="Permalink to My attempts at MapReduce with MongoDB">My attempts at MapReduce with MongoDB</a>
  </div>

  <div id="article_text">
    <p>I was sorting a tree in my (python) webapp instead of having the database to do it for me. This is how I moved it back to the database by using a <a class="reference external" href="http://en.wikipedia.org/wiki/MapReduce">MapReduce</a> job. I had a collection structured like the following:</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="err">...</span><span class="p">,</span>
  <span class="nt">&quot;feed_oid&quot;</span> <span class="p">:</span> <span class="s2">&quot;4fd268d2ab87b2d8927d7eee&quot;</span><span class="p">,</span>
  <span class="nt">&quot;title&quot;</span> <span class="p">:</span> <span class="s2">&quot;blah blah&quot;</span><span class="p">,</span>
  <span class="nt">&quot;updated&quot;</span> <span class="p">:</span> <span class="mi">1339702524</span><span class="p">,</span>
  <span class="nt">&quot;watchers&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;4fd276fc66224c1ee8000006&quot;</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>Such a collection is called <code>articles</code> and in there I get a document for every article published by an rss feed. <code>feed_oid</code> is an identifier I assign to every rss feed that I'm crawling and <code>watchers</code> contains a list of identifiers assigned to the people voting on such an article.</p>
<p>I wanted to find out the number of times a particular watcher appeared in the full list of articles and than, group that by the rss feed, so that I could end up with the number of times a person voted on articles published by the same feed.</p>
<p>The following are my map and reduce functions:</p>
<div class="highlight"><pre><span class="nx">m</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">feed_oid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span class="nx">r</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">oids</span><span class="p">,</span> <span class="nx">vals</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">vals</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">vals</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>The map function is called for every object matching the query filter, so it gets access to 'this'. The reduce function receives an array of values (all set to 1, by my map function) for every feed_oid emitted.</p>
<p>Here is how I spawn the MapReduce job (querying by the watcher id):</p>
<div class="highlight"><pre><span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span><span class="nx">watchers</span><span class="o">:</span> <span class="s2">&quot;4fd276fc66224c1ee8000006&quot;</span><span class="p">},</span>
  <span class="nx">out</span><span class="o">:</span> <span class="s2">&quot;mapreduceout&quot;</span>
<span class="p">});</span>
</pre></div>
<p>The results:</p>
<div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">mapreduceout</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;4fd268d2ab87b2d8927d7eea&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;4fd268d2ab87b2d8927d7eee&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="mi">4</span> <span class="p">}</span>
</pre></div>
<p>Looks like this guy voted 4 times on articles appeared on the feed 4fd268d2ab87b2d8927d7eee and 1 4fd268d2ab87b2d8927d7eea :P</p>

  </div>

  <div id="article_meta">
    <p>Category: <a href="../../category/techie.html">techie</a></p>
        <p>Tags:
            <a href="../../tag/mapreduce.html">mapreduce</a>,            <a href="../../tag/fedoraplanet.html">fedoraplanet</a>,            <a href="../../tag/mongodb.html">mongodb</a>          </p>
      </div>
</article>
<footer>
  <a href="../../" class="button_accent">&larr; Back to Index</a>
</footer>
  </main>

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-39216528-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>