<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Giulio Fidente</title><link href="http://giuliofidente.com/" rel="alternate"></link><link href="http://giuliofidente.com/feeds/tag/ceph.atom.xml" rel="self"></link><id>http://giuliofidente.com/</id><updated>2016-08-26T05:00:00+02:00</updated><entry><title>Ceph, TripleO and the Newton release</title><link href="http://giuliofidente.com/2016/08/ceph-tripleo-and-the-newton-release.html" rel="alternate"></link><updated>2016-08-26T05:00:00+02:00</updated><author><name>Giulio Fidente</name></author><id>tag:giuliofidente.com,2016-08-26:2016/08/ceph-tripleo-and-the-newton-release.html</id><summary type="html">&lt;p&gt;Time to roll up some notes on the status of Ceph in TripleO. The majority of these functionalities were available in the Mitaka release too but the examples work with code from the Newton release so they might not apply identical to Mitaka.&lt;/p&gt;
&lt;div class="section" id="the-tripleo-default-configuration"&gt;
&lt;h2&gt;The TripleO default configuration&lt;/h2&gt;
&lt;p&gt;No default is going to fit everybody, but we want to know what the default is to improve from there. So let's try and see:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
uc$ openstack overcloud deploy --templates tripleo-heat-templates -e tripleo-heat-templates/environments/puppet-pacemaker.yaml -e tripleo-heat-templates/environments/storage-environment.yaml --ceph-storage-scale 1
Deploying templates in the directory /home/stack/example/tripleo-heat-templates
...
Overcloud Deployed
&lt;/pre&gt;
&lt;p&gt;Monitors go on the &lt;cite&gt;controller&lt;/cite&gt; nodes, one per node, the above command is deploying a single controller though. First interesting thing to point out is:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph --version
ceph version 10.2.2 (45107e21c568dd033c2f0a3107dec8f0b0e58374)
&lt;/pre&gt;
&lt;p&gt;Jewel! Kudos to &lt;a class="reference external" href="http://my1.fr/blog/"&gt;Emilien&lt;/a&gt; for bringing support for it in &lt;code&gt;puppet-ceph&lt;/code&gt;. Continuing our investigation, we notice the OSDs go on the &lt;cite&gt;cephstorage&lt;/cite&gt; nodes and are backed by the local filesystem, as we didn't tell it to do differently:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph osd tree
ID WEIGHT  TYPE NAME                        UP/DOWN REWEIGHT PRIMARY-AFFINITY
-1 0.03999 root default
-2 0.03999     host overcloud-cephstorage-0
 0 0.03999         osd.0                         up  1.00000          1.00000
&lt;/pre&gt;
&lt;p&gt;Notice we got SELinux covered:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ls -laZ /srv/data
drwxr-xr-x. ceph ceph system_u:object_r:ceph_var_lib_t:s0 .
...
&lt;/pre&gt;
&lt;p&gt;And use CephX with autogenerated keys:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph auth list
installed auth entries:

client.admin
        key: AQC2Pr9XAAAAABAAOpviw6DqOMG0syeEYmX2EQ==
        caps: [mds] allow *
        caps: [mon] allow *
        caps: [osd] allow *
client.openstack
        key: AQC2Pr9XAAAAABAAA78Svmmt+LVIcRrZRQLacw==
        caps: [mon] allow r
        caps: [osd] allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=backups, allow rwx pool=vms, allow rwx pool=images, allow rwx pool=metrics
&lt;/pre&gt;
&lt;p&gt;But which OpenStack service is using Ceph? The &lt;code&gt;storage-environment.yaml&lt;/code&gt; file has some informations:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
uc$ grep -v '#' tripleo-heat-templates/environments/storage-environment.yaml | uniq

 resource_registry:
   OS::TripleO::Services::CephMon: ../puppet/services/ceph-mon.yaml
   OS::TripleO::Services::CephOSD: ../puppet/services/ceph-osd.yaml
   OS::TripleO::Services::CephClient: ../puppet/services/ceph-client.yaml

 parameter_defaults:
   CinderEnableIscsiBackend: false
   CinderEnableRbdBackend: true
   CinderBackupBackend: ceph
   NovaEnableRbdBackend: true
   GlanceBackend: rbd
   GnocchiBackend: rbd
&lt;/pre&gt;
&lt;p&gt;The registry lines enable the Ceph services, the parameters instead are setting Ceph as backend for Cinder, Nova, Glance and Gnocchi. They can be configured to use other backends, see the comments in the environment file. Regarding the pools:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph osd lspools
0 rbd,1 metrics,2 images,3 backups,4 volumes,5 vms,
&lt;/pre&gt;
&lt;p&gt;Despite the replica size set by default to 3, we only have a single OSD so with a single OSD the cluster will never get into HEALTH_OK:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph osd pool get vms size
size: 3
&lt;/pre&gt;
&lt;p&gt;Good to know, now a new deployment with more interesting stuff.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="a-more-realistic-scenario"&gt;
&lt;h2&gt;A more realistic scenario&lt;/h2&gt;
&lt;p&gt;What makes it &amp;quot;more realistic&amp;quot;? We'll have enough OSDs to cover the replica size. We'll use physical disks for our OSDs (and journals) and not the local filesystem. We'll cope with a node with a different disks topology and we'll decrease the replica size for one of the pools.&lt;/p&gt;
&lt;div class="section" id="set-a-default-disks-map-for-the-osd-nodes"&gt;
&lt;h3&gt;Set a default disks map for the OSD nodes&lt;/h3&gt;
&lt;p&gt;Define a default configuration for the storage nodes, telling TripleO to use &lt;code&gt;sdb&lt;/code&gt; for the OSD data and &lt;code&gt;sdc&lt;/code&gt; for the journal:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ceph_default_disks.yaml
  parameter_defaults:
    CephStorageExtraConfig:
      ceph::profile::params::osds:
        /dev/sdb:
          journal: /dev/sdc
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="customize-the-disks-map-for-a-specific-node"&gt;
&lt;h3&gt;Customize the disks map for a specific node&lt;/h3&gt;
&lt;p&gt;For the node which has two (instead of a single) rotatory disks, we'll need a specific map. First get its system-uuid from the Ironic introspection data:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
uc$ openstack baremetal introspection data save | jq .extra.system.product.uuid
&amp;quot;66C033FA-BAC0-4364-9E8A-3184B5952370&amp;quot;
&lt;/pre&gt;
&lt;p&gt;then create the node specific map:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ceph_mynode_disks.yaml
  resource_registry:
    OS::TripleO::CephStorageExtraConfigPre: tripleo-heat-templates/puppet/extraconfig/pre_deploy/per_node.yaml

  parameter_defaults:
    NodeDataLookup: &amp;gt;
     {&amp;quot;66C033FA-BAC0-4364-9E8A-3184B5952370&amp;quot;:
       {&amp;quot;ceph::profile::params::osds&amp;quot;:
         {&amp;quot;/dev/sdb&amp;quot;: {&amp;quot;journal&amp;quot;: &amp;quot;/dev/sdd&amp;quot;},
          &amp;quot;/dev/sdc&amp;quot;: {&amp;quot;journal&amp;quot;: &amp;quot;/dev/sdd&amp;quot;}
         }
       }
     }
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fine-tune-pg-num-pgp-num-and-replica-size-for-a-pool"&gt;
&lt;h3&gt;Fine tune pg_num, pgp_num and replica size for a pool&lt;/h3&gt;
&lt;p&gt;Finally, to override the replica size (and why not, PGs number) of the &amp;quot;vms&amp;quot; pool (where by default the Nova ephemeral disks go):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ceph_pools_config.yaml
  parameter_defaults:
    CephPools:
      vms:
        size: 2
        pg_num: 128
        pgp_num: 128
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="zap-all-disks-for-the-new-deployment"&gt;
&lt;h3&gt;Zap all disks for the new deployment&lt;/h3&gt;
&lt;p&gt;We also want to clear and prepare all the non-root disks with a GPT label, which will allow us, for example, to repeat the deployment multiple times reusing the same nodes. The implementation of the disks cleanup script can vary, but we can use &lt;a class="reference external" href="https://gist.github.com/gfidente/42d3cdfe0c67f7c95f0c"&gt;a sample script&lt;/a&gt; and wire it to the overcloud nodes via &lt;cite&gt;NodeUserData&lt;/cite&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
uc$ curl -O https://gist.githubusercontent.com/gfidente/42d3cdfe0c67f7c95f0c/raw/1f467c6018ada194b54f22113522db61ef944e20/ceph_wipe_disk.yaml

ceph_wipe_env.yaml:
  resource_registry:
    OS::TripleO::NodeUserData: ceph_wipe_disk.yaml

  parameter_defaults:
    ceph_disks: &amp;quot;/dev/sdb /dev/sdc /dev/sdd&amp;quot;
&lt;/pre&gt;
&lt;p&gt;All the above environment files could have been merged in a single one but we split them out in multiple ones for clarity. Now the new deploy command:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
uc$ openstack overcloud deploy --templates tripleo-heat-templates -e tripleo-heat-templates/environments/puppet-pacemaker.yaml -e tripleo-heat-templates/environments/storage-environment.yaml --ceph-storage-scale 3 -e ceph_pools_config.yaml -e ceph_mynode_disks.yaml -e ceph_default_disks.yaml -e ceph_wipe_env.yaml
Deploying templates in the directory /home/stack/example/tripleo-heat-templates
...
Overcloud Deployed
&lt;/pre&gt;
&lt;p&gt;Here is our OSDs tree, with two instances running on the node with two rotatory disks (sharing the same journal disk):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph os tree
ID WEIGHT  TYPE NAME                        UP/DOWN REWEIGHT PRIMARY-AFFINITY
-1 0.03119 root default
-2 0.00780     host overcloud-cephstorage-1
 0 0.00780         osd.0                         up  1.00000          1.00000
-3 0.01559     host overcloud-cephstorage-2
 1 0.00780         osd.1                         up  1.00000          1.00000
 2 0.00780         osd.2                         up  1.00000          1.00000
-4 0.00780     host overcloud-cephstorage-0
 3 0.00780         osd.3                         up  1.00000          1.00000
&lt;/pre&gt;
&lt;p&gt;and the custom PG/size values for for &amp;quot;vms&amp;quot; pool:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
oc$ ceph osd pool get vms size
size: 2
oc$ ceph osd pool get vms pg_num
pg_num: 128
&lt;/pre&gt;
&lt;p&gt;Another simple customization could have been to set the journals size. For example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ceph_journal_size.yaml
  parameter_defaults:
    ExtraConfig:
      ceph::profile::params::osd_journal_size: 1024
&lt;/pre&gt;
&lt;p&gt;Also we did not provide any customization for the &lt;cite&gt;crushmap&lt;/cite&gt; but &lt;a class="reference external" href="https://github.com/openstack/puppet-ceph/commit/b1af406398488df7fc3d35263451f3e2ad802b9b"&gt;a recent addition&lt;/a&gt; from &lt;a class="reference external" href="https://twitter.com/epkuva"&gt;Erno&lt;/a&gt; makes it possible to disable &lt;code&gt;global/osd_crush_update_on_start&lt;/code&gt; so that any customization becomes possible after the deployment is finished.&lt;/p&gt;
&lt;p&gt;Also we did not deploy the RadosGW service as it is still a work in progress, expected for the Newton release. Submissions for its inclusion are &lt;a class="reference external" href="https://review.openstack.org/#/c/289027/"&gt;on review&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We're also working on automating the upgrade from the Ceph/Hammer release deployed with TripleO/Mitaka to Ceph/Jewel, installed with TripleO/Newton. The process will be integrated with the OpenStack upgrade and again the submissions are &lt;a class="reference external" href="https://review.openstack.org/#/c/359410/"&gt;on review in a series&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="for-more-scenarios"&gt;
&lt;h2&gt;For more scenarios&lt;/h2&gt;
&lt;p&gt;The mechanism recently introduced in TripleO to make composable roles, discussed in a &lt;a class="reference external" href="http://hardysteven.blogspot.it/2016/08/tripleo-composable-services-101.html"&gt;Steven&lt;/a&gt;'s blog post, makes it possible to test a complete Ceph deployment using a single controller node too (hosting the OSD service as well), just by adding &lt;code&gt;OS::TripleO::Services::CephOSD&lt;/code&gt; to the list of services deployed on the controller role.&lt;/p&gt;
&lt;p&gt;And if the above still wasn't enough, TripleO continues to support configuration of OpenStack with a pre-existing, unmanaged Ceph cluster. To do so we'll want to customize the parameters in &lt;code&gt;puppet-ceph-external.yaml&lt;/code&gt; and deploy passing that as argument instead. For example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
puppet-ceph-external.yaml
  resource_registry:
    OS::TripleO::Services::CephExternal: tripleo-heat-templates/puppet/services/ceph-external.yaml

  parameter_defaults:
    # NOTE: These example parameters are required when using Ceph External and must be obtained from the running cluster
    #CephClusterFSID: '4b5c8c0a-ff60-454b-a1b4-9747aa737d19'
    #CephClientKey: 'AQDLOh1VgEp6FRAAFzT7Zw+Y9V6JJExQAsRnRQ=='
    #CephExternalMonHost: '172.16.1.7, 172.16.1.8'

    # the following parameters enable Ceph backends for Cinder, Glance, Gnocchi and Nova
    NovaEnableRbdBackend: true
    CinderEnableRbdBackend: true
    CinderBackupBackend: ceph
    GlanceBackend: rbd
    GnocchiBackend: rbd
    # If the Ceph pools which host VMs, Volumes and Images do not match these
    # names OR the client keyring to use is not named 'openstack',  edit the
    # following as needed.
    NovaRbdPoolName: vms
    CinderRbdPoolName: volumes
    GlanceRbdPoolName: images
    GnocchiRbdPoolName: metrics
    CephClientUserName: openstack
    # finally we disable the Cinder LVM backend
    CinderEnableIscsiBackend: false
&lt;/pre&gt;
&lt;p&gt;Come help in #tripleo &amp;#64; freenode and don't forget to check the docs at &lt;a class="reference external" href="http://tripleo.org"&gt;tripleo.org&lt;/a&gt;! Some related topics are described there, for example, how to &lt;a class="reference external" href="http://tripleo.org/advanced_deployment/root_device.html"&gt;set the root device&lt;/a&gt; via Ironic for the nodes with multiple disks or how to &lt;a class="reference external" href="http://tripleo.org/advanced_deployment/ceph_config.html"&gt;push in ceph.conf&lt;/a&gt; additional arbitraty settings.&lt;/p&gt;
&lt;/div&gt;
</summary><category term="openstack"></category><category term="ceph"></category><category term="tripleo"></category></entry><entry><title>Ceph for Cinder in TripleO</title><link href="http://giuliofidente.com/2015/01/ceph-for-cinder-in-tripleo.html" rel="alternate"></link><updated>2015-01-06T17:15:00+01:00</updated><author><name>Giulio Fidente</name></author><id>tag:giuliofidente.com,2015-01-06:2015/01/ceph-for-cinder-in-tripleo.html</id><summary type="html">&lt;p&gt;A wrap up on the status of TripleO's Cinder HA spec. First, a link to the &lt;a class="reference external" href="https://blueprints.launchpad.net/tripleo/+spec/tripleo-kilo-cinder-ha"&gt;cinder-ha blueprint&lt;/a&gt;, where you can find even more links, to the actual spec (under review) and the code changes (again, still under review). Intent of the blueprint is for the &lt;a class="reference external" href="https://wiki.openstack.org/wiki/TripleO"&gt;TripleO&lt;/a&gt; deployments to keep Cinder volumes available and Cinder operational in case of failures of any node.&lt;/p&gt;
&lt;p&gt;This said, should $subject sound interesting to you, beware the code still needs reviews, probably polishing and surely more features ... so take this post as a call for help as well! Now some details.&lt;/p&gt;
&lt;p&gt;For Cinder to remain operational, in &lt;a class="reference external" href="https://wiki.openstack.org/wiki/TripleO"&gt;TripleO&lt;/a&gt; we deploy the &lt;code&gt;cinder-{api,schduler,volume}&lt;/code&gt; services on all controller nodes (as it was even before the proposed spec) but we also customize the &lt;code&gt;host&lt;/code&gt; setting so that all instances of &lt;code&gt;cinder-volume&lt;/code&gt; will share an identical identifier. This is so that all instances can perform operations on all volumes, otherwise, the particular host which created a volume would be the only one capable of performing further operations on it. This exposed some potential issues with Cinder due to concurrent mutation of same resource from multiple nodes and they already are taken care of, in Cinder, with the &lt;a class="reference external" href="https://blueprints.launchpad.net/cinder/+spec/cinder-state-enforcer"&gt;state-enforcer blueprint&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Then, for the volumes to remain available, &lt;a class="reference external" href="https://wiki.openstack.org/wiki/TripleO"&gt;TripleO&lt;/a&gt; will deploy a Ceph cluster together with the OpenStack components, to be used as a backend for Cinder. Each and every controller will host a Ceph monitor while an arbitrary number of additional nodes can be configured as Ceph OSDs. The basic idea is that by doing so people will be able to scale out the number of controllers and/or data nodes independently, in an attempt to suit the needs for more space or more CPU resources depending on the use case. In addition to that, network partitioning should also be easy to achieve as traffic from Nova nodes will be directed to the OSDs nodes only for volumes I/O, not to the controllers. Note though that the existing implementation &lt;strong&gt;does not yet&lt;/strong&gt; implement support for the network partitioning but, on a good note, &lt;strong&gt;it does&lt;/strong&gt; use cephx already to secure access to data.&lt;/p&gt;
&lt;p&gt;As of today, assuming you checkout by yourself, as linked from the &lt;a class="reference external" href="https://blueprints.launchpad.net/tripleo/+spec/tripleo-kilo-cinder-ha"&gt;cinder-ha blueprint&lt;/a&gt;, the needed &lt;a class="reference external" href="https://wiki.openstack.org/wiki/TripleO"&gt;TripleO&lt;/a&gt; changes, everything should &lt;em&gt;just work&lt;/em&gt; by setting some value &amp;gt; 0 for the &lt;code&gt;CEPHSTORAGESCALE&lt;/code&gt; env variable, which represents the number of OSD nodes you want to deploy. Should you need it, in the Heat templates it is possible to customize a number of useful Ceph settings, like the number of replicas for the data (needs to be lower than the number of OSD nodes). Now go try it out and come back with some feedback! :)&lt;/p&gt;
</summary><category term="openstack"></category><category term="cinder"></category><category term="tripleo"></category><category term="ceph"></category><category term="high availability"></category><category term="fedoraplanet"></category></entry></feed>